
### 🔍 مقدمه:  
**Referencing to Common Average (میانگین گرفتن عمومی)** یک روش متداول در پردازش سیگنال‌های زیستی (مثل EEG) است که در آن، میانگین تمام کانال‌ها (Channels) از هر نمونه (Sample) خاص کم می‌شود. این کار به منظور حذف مؤلفه DC (مقدار متوسط ثابت) و همچنین کاهش نویز مشترک بین کانال‌ها صورت می‌گیرد.

---

## ✅ مرحله به مرحله: Referencing to Common Average

### 📌 فرض کنید:
سیگنال ما شامل 3 کانال و 3 نمونه است:

```matlab
x = [7, 6, 5; ...
      12, 10, 8; ...
      24, 21, 18];
```

این یعنی داریم:

| Channel | Sample 1 | Sample 2 | Sample 3 |
|---------|----------|----------|----------|
| C1      | 7        | 6        | 5        |
| C2      | 12       | 10       | 8        |
| C3      | 24       | 21       | 18       |

---

### 🧮 محاسبه میانگین عمومی (Common Average)

برای **هر نمونه** (ستون)، میانگین تمام کانال‌ها را محاسبه می‌کنیم:

#### مثال برای Sample 1:

![Sample 1 Mean](https://latex.codecogs.com/svg.latex?\text{mean}_1%20=%20\frac{7%20+%2012%20+%2024}{3}%20=%20\frac{43}{3}%20=%2014.33)

#### Sample 2:

![Sample 2 Mean](https://latex.codecogs.com/svg.latex?\text{mean}_2%20=%20\frac{6%20+%2010%20+%2021}{3}%20=%20\frac{37}{3}%20=%2012.33)

#### Sample 3:

![Sample 3 Mean](https://latex.codecogs.com/svg.latex?\text{mean}_3%20=%20\frac{5%20+%208%20+%2018}{3}%20=%20\frac{31}{3}%20=%2010.33)

پس:

```matlab
mean_x = [14.33, 12.33, 10.33];
```

---

### ❌ حذف میانگین عمومی از هر کانال

حال برای هر کانال و در هر نمونه، مقدار میانگین عمومی آن نمونه را از مقدار اصلی کم می‌کنیم:

#### برای C1:

- Sample 1: `7 - 14.33 = -7.33`
- Sample 2: `6 - 12.33 = -6.33`
- Sample 3: `5 - 10.33 = -5.33`

#### برای C2:

- Sample 1: `12 - 14.33 = -2.33`
- Sample 2: `10 - 12.33 = -2.33`
- Sample 3: `8 - 10.33 = -2.33`

#### برای C3:

- Sample 1: `24 - 14.33 = 9.67`
- Sample 2: `21 - 12.33 = 8.67`
- Sample 3: `18 - 10.33 = 7.67`

سیگنال جدید بدون میانگین عمومی:

```matlab
xm = [-7.33, -6.33, -5.33;
      -2.33, -2.33, -2.33;
       9.67,  8.67,  7.67];
```

---

### 💻 کد متلب: Referencing to Common Average

```matlab
% سیگنال اولیه
x = [7, 6, 5;
     12, 10, 8;
     24, 21, 18];

% تعداد کانال‌ها و نمونه‌ها
[M, N] = size(x); % M = 3 کانال، N = 3 نمونه

% محاسبه میانگین عمومی برای هر نمونه
mean_x = mean(x); % mean_x = [14.33, 12.33, 10.33]

% ساخت سیگنال بدون میانگین عمومی
xm = zeros(M, N);
for j = 1:N
    xm(:, j) = x(:, j) - mean_x(1, j);
end

% نمایش خروجی
disp('Original Signal:');
disp(x);
disp('Common Average per sample:');
disp(mean_x);
disp('Signal after referencing to common average:');
disp(xm);
```

---

### 🖥️ خروجی برنامه:

```
Original Signal:
     7     6     5
    12    10     8
    24    21    18

Common Average per sample:
   14.3333   12.3333   10.3333

Signal after referencing to common average:
   -7.3333   -6.3333   -5.3333
   -2.3333   -2.3333   -2.3333
    9.6667    8.6667    7.6667
```

---

## 📊 تحلیل خروجی

- **میانگین عمومی** برای هر نمونه محاسبه شده.
- این مقدار از تمام کانال‌ها در همان نمونه کم شده.
- نتیجه: سیگنال مرکز شده حول صفر با میانگین صفر برای هر نمونه.

---

## 📈 مقایسه انرژی قبل و بعد از حذف میانگین عمومی

### انرژی قبل از حذف:

![Original Energy](https://latex.codecogs.com/svg.latex?E_{original}%20=%20\sum%20x^2%20=%207^2%20+%206^2%20+%205^2%20+%2012^2%20+%2010^2%20+%208^2%20+%2024^2%20+%2021^2%20+%2018^2%20=%201739)

### انرژی بعد از حذف:

![Centered Energy](https://latex.codecogs.com/svg.latex?E_{centered}%20=%20(-7.33)^2%20+%20(-6.33)^2%20+%20...%20+%207.67^2%20\approx%20233.3)

مشاهده می‌کنیم که انرژی کلی کاهش یافته است، چون مؤلفه DC (ثابت) حذف شده است.

---

## 📚 سوالات مثالی

### سوال ۱:
اگر سیگنال زیر داده شده باشد:

```matlab
x = [1, 2, 3;
     4, 5, 6;
     7, 8, 9];
```

میانگین عمومی هر نمونه را محاسبه کنید و سیگنال بدون میانگین عمومی را به دست آورید.

**حل:**

- میانگین هر ستون:
  - Sample 1: `(1+4+7)/3 = 4`
  - Sample 2: `(2+5+8)/3 = 5`
  - Sample 3: `(3+6+9)/3 = 6`

- سیگنال بدون میانگین:

```matlab
xm = [-3, -3, -3;
      0, 0, 0;
      3, 3, 3];
```

---

### سوال ۲:
در سیگنال زیر:

```matlab
x = [10, 12, 14;
     20, 22, 24;
     30, 32, 34];
```

آیا بعد از حذف میانگین عمومی، تمام کانال‌ها شبیه هم خواهند بود؟ چرا؟

**جواب:**
بله، چون سیگنال خطی است و اختلاف بین کانال‌ها ثابت است. بنابراین میانگین عمومی نیز به طور یکنواخت کم خواهد شد و اختلاف بین کانال‌ها حفظ می‌شود.

---

### سوال ۳:
فرض کنید سیگنال زیر داده شده است:

```matlab
x = [10, 20, 30;
     40, 50, 60;
     70, 80, 90];
```

انرژی سیگنال قبل و بعد از حذف میانگین عمومی را محاسبه کنید.

**حل:**

- انرژی اولیه:  
  ![Initial Energy](https://latex.codecogs.com/svg.latex?E%20=%2010^2%20+%2020^2%20+%20...%20+%2090^2%20=%2028500)

- میانگین هر ستون: `[40, 50, 60]`

- سیگنال بدون میانگین:
  ```matlab
  xm = [-30, -30, -30;
        0, 0, 0;
        30, 30, 30];
  ```

- انرژی جدید:
  ![New Energy](https://latex.codecogs.com/svg.latex?E_{new}%20=%203*(-30)^2%20+%203*(30)^2%20=%205400)

---

## ✅ خلاصه

| عنصر | مقدار |
|------|--------|
| سیگنال اولیه | `x = [7, 6, 5; 12, 10, 8; 24, 21, 18]` |
| میانگین عمومی | `[14.33, 12.33, 10.33]` |
| سیگنال بدون میانگین | `[-7.33, -6.33, -5.33; -2.33, -2.33, -2.33; 9.67, 8.67, 7.67]` |
| انرژی اولیه | `1739` |
| انرژی بعد از حذف | `~233.3` |

---

## 🛠️ کاربردها

- **EEG/ERP**: حذف نویز مشترک بین الکترودها.
- **کاهش نویز**: اگر نویز مشترک بین کانال‌ها باشد، حذف می‌شود.
- **تجزیه و تحلیل PCA/ICA**: آماده‌سازی سیگنال برای روش‌های تجزیه.

